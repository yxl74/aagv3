<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Run {{ analysis_id }}</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; margin: 24px; color: #111; }
    a { color: #2563eb; text-decoration: none; }
    h1 { margin-bottom: 4px; }
    .section { margin-top: 28px; }
    table { border-collapse: collapse; width: 100%; margin-top: 8px; }
    th, td { border-bottom: 1px solid #e5e7eb; padding: 8px 10px; text-align: left; vertical-align: top; }
    th { font-size: 12px; text-transform: uppercase; letter-spacing: 0.04em; color: #6b7280; }
    code { background: #f3f4f6; padding: 2px 4px; border-radius: 4px; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #f3f4f6; font-size: 12px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .card { border: 1px solid #e5e7eb; padding: 12px; border-radius: 8px; }
    .flow-toggle { display: flex; align-items: center; gap: 8px; margin: 8px 0 12px; font-size: 14px; }
    .level-error { background: #fee2e2; }
    .level-info { background: #fff; }
    details > summary { cursor: pointer; color: #2563eb; }
    .status-pill { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .status-live { background: #dcfce7; color: #166534; }
    .status-off { background: #f3f4f6; color: #374151; }
  </style>
</head>
<body>
  <a href="/runs">&larr; Back to runs</a>
  <h1>Run {{ analysis_id }}</h1>
  <p>Artifacts dir: {{ artifacts_dir }}</p>
  {% if run_id %}
  <p>Run ID: <code>{{ run_id }}</code></p>
  {% endif %}

  <div class="section">
    <h2>Stage Timeline</h2>
    <table id="stage-table">
      <thead>
        <tr>
          <th>Stage</th>
          <th>Start</th>
          <th>End</th>
          <th>Status</th>
          <th>Duration (s)</th>
        </tr>
      </thead>
      <tbody id="stage-body">
        {% for stage in stages %}
        <tr data-stage="{{ stage.stage }}">
          <td>{{ stage.stage }}</td>
          <td>{{ stage.start_ts or "-" }}</td>
          <td>{{ stage.end_ts or "-" }}</td>
          <td>{{ stage.status or "-" }}</td>
          <td>{{ stage.duration_sec or "-" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="section">
    <h2>Execution Flow</h2>
    <div class="flow-toggle">
      <label>
        <input type="checkbox" id="toggle-all-events">
        Show all events
      </label>
      <label>
        <input type="checkbox" id="toggle-live" checked>
        Live
      </label>
      <span id="live-status" class="status-pill status-live">Connecting</span>
    </div>
    {% if execution_flow %}
    <table id="flow-table">
      <thead>
        <tr>
          <th>Time</th>
          <th>Event</th>
          <th>Stage</th>
          <th>Summary</th>
          <th>Ref</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        {% for event in execution_flow %}
        <tr data-kind="{{ 'stage' if event.is_stage else 'event' }}" class="level-{{ event.level }}">
          <td>{{ event.ts or "-" }}</td>
          <td>{{ event.event_type or "-" }}</td>
          <td>{{ event.stage or "-" }}</td>
          <td>{{ event.summary or "-" }}</td>
          <td>
            {% if event.ref %}
            <a href="/runs/{{ analysis_id }}/artifact/{{ event.ref }}">{{ event.ref }}</a>
            {% else %}-{% endif %}
          </td>
          <td>
            {% if event.details %}
            <details>
              <summary>Details</summary>
              <pre>{{ event.details }}</pre>
            </details>
            {% else %}-{% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
      <p>No events recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Seeding</h2>
    {% if seeding %}
    <div class="grid">
      <div class="card">
        <div class="pill">Callsites</div>
        <div>{{ seeding.callsite_count }}</div>
      </div>
      <div class="card">
        <div class="pill">Categories</div>
        <pre>{{ seeding.category_counts }}</pre>
      </div>
      <div class="card">
        <div class="pill">Confidence</div>
        <pre>{{ seeding.confidence_counts }}</pre>
      </div>
    </div>
    {% if seeding.ref %}
      <p><a href="/runs/{{ analysis_id }}/artifact/{{ seeding.ref }}">View seed index</a></p>
    {% endif %}
    {% else %}
    <p>No seeding stats recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Sensitive API Hits</h2>
    {% if sensitive_api %}
      <p>Total hits: {{ sensitive_api.total_hits }}</p>
      {% if sensitive_api.ref %}
      <a href="/runs/{{ analysis_id }}/artifact/{{ sensitive_api.ref }}">View sensitive_api_hits.json</a>
      {% endif %}
    {% else %}
      <p>No sensitive API hits recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Threat Triage (Recon)</h2>
    {% if recon %}
      <p>Threat level: <strong>{{ recon.threat_level }}</strong> | Cases: {{ recon.case_count }}</p>
      {% if recon.fallback_reason %}
      <p>LLM fallback reason: <code>{{ recon.fallback_reason }}</code></p>
      {% endif %}
      {% if recon.llm_valid is not none %}
      <p>LLM valid: <code>{{ recon.llm_valid }}</code></p>
      {% endif %}
      {% if recon.ref %}
      <a href="/runs/{{ analysis_id }}/artifact/{{ recon.ref }}">View recon JSON</a>
      {% endif %}
    {% else %}
      <p>No recon output recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Soot Graphs</h2>
    {% if graphs %}
      <div class="grid">
        <div class="card">
          <div class="pill">Nodes</div>
          <div>{{ graphs.node_count }}</div>
        </div>
        <div class="card">
          <div class="pill">Edges</div>
          <div>{{ graphs.edge_count }}</div>
        </div>
        <div class="card">
          <div class="pill">CFG Files</div>
          <div>{{ graphs.cfg_count }}</div>
        </div>
      </div>
      {% if graphs.callgraph_ref %}
      <p><a href="/runs/{{ analysis_id }}/artifact/{{ graphs.callgraph_ref }}">View callgraph JSON</a></p>
      {% endif %}
      {% if graphs.class_hierarchy_ref %}
      <p><a href="/runs/{{ analysis_id }}/artifact/{{ graphs.class_hierarchy_ref }}">View class hierarchy JSON</a></p>
      {% endif %}
    {% else %}
      <p>No callgraph stats recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Context Bundles</h2>
    {% if bundles %}
      <p>Total bundles: {{ bundles.bundle_count }} | Avg slice units: {{ bundles.avg_slice_units }}</p>
      {% if bundles.sample_slice_refs %}
        <ul>
        {% for ref in bundles.sample_slice_refs %}
          <li><a href="/runs/{{ analysis_id }}/artifact/{{ ref }}">{{ ref }}</a></li>
        {% endfor %}
        </ul>
      {% endif %}
      {% if bundles.sample_path_refs %}
        <p>Sample entrypoint paths:</p>
        <ul>
        {% for ref in bundles.sample_path_refs %}
          <li><a href="/runs/{{ analysis_id }}/artifact/{{ ref }}">{{ ref }}</a></li>
        {% endfor %}
        </ul>
      {% endif %}
      {% if bundles.entrypoint_paths_ref %}
        <p><a href="/runs/{{ analysis_id }}/artifact/{{ bundles.entrypoint_paths_ref }}">View entrypoint paths summary</a></p>
      {% endif %}
    {% else %}
      <p>No context bundle stats recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>FlowDroid</h2>
    {% if flowdroid %}
      <p>Flow count: {{ flowdroid.flow_count }}</p>
      {% if flowdroid.ref %}
      <a href="/runs/{{ analysis_id }}/artifact/{{ flowdroid.ref }}">View FlowDroid summary</a>
      {% endif %}
    {% else %}
      <p>No FlowDroid summary recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>LLM I/O</h2>
    {% if llm_events %}
    <table>
      <thead>
        <tr>
          <th>Event</th>
          <th>Step</th>
          <th>Seed</th>
          <th>Ref</th>
          <th>Size</th>
          <th>Prompt chars</th>
          <th>Payload chars</th>
          <th>Error</th>
        </tr>
      </thead>
      <tbody>
        {% for event in llm_events %}
        <tr>
          <td>{{ event.event_type }}</td>
          <td>{{ event.llm_step or "-" }}</td>
          <td>{{ event.seed_id or "-" }}</td>
          <td>
            {% if event.ref %}
            <a href="/runs/{{ analysis_id }}/artifact/{{ event.ref }}">{{ event.ref }}</a>
            {% else %}-{% endif %}
          </td>
          <td>{{ event.size or "-" }}</td>
          <td>{{ event.prompt_chars or "-" }}</td>
          <td>{{ event.payload_chars or "-" }}</td>
          <td>{{ event.error_type or "-" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
      <p>No LLM events recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>API + Tool Events</h2>
    {% if api_events %}
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Event</th>
          <th>Method</th>
          <th>Path/Tool</th>
          <th>Status</th>
          <th>Ref</th>
          <th>Extra</th>
        </tr>
      </thead>
      <tbody>
        {% for event in api_events %}
        <tr>
          <td>{{ event.ts or "-" }}</td>
          <td>{{ event.event_type }}</td>
          <td>{{ event.method or "-" }}</td>
          <td>{{ event.path or "-" }}</td>
          <td>{{ event.status or "-" }}</td>
          <td>
            {% if event.ref %}
            <a href="/runs/{{ analysis_id }}/artifact/{{ event.ref }}">{{ event.ref }}</a>
            {% else %}-{% endif %}
          </td>
          <td>{% if event.extra %}<pre>{{ event.extra }}</pre>{% else %}-{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
      <p>No API/tool events recorded.</p>
    {% endif %}
  </div>
  <script>
    const toggle = document.getElementById('toggle-all-events');
    const liveToggle = document.getElementById('toggle-live');
    const liveStatus = document.getElementById('live-status');
    const flowTable = document.getElementById('flow-table');
    const flowBody = flowTable ? flowTable.querySelector('tbody') : null;
    const stageTable = document.getElementById('stage-table');
    const stageBody = stageTable ? stageTable.querySelector('tbody') : null;
    const rows = Array.from(document.querySelectorAll('#flow-table tbody tr'));
    const analysisId = "{{ analysis_id }}";
    const runId = "{{ run_id or '' }}";
    let eventSource = null;
    const stageRows = new Map();
    const stageState = new Map();

    if (stageBody) {
      stageBody.querySelectorAll('tr[data-stage]').forEach((tr) => {
        const stageName = tr.dataset.stage;
        if (stageName) {
          stageRows.set(stageName, tr);
          const cells = tr.querySelectorAll('td');
          if (cells.length >= 5) {
            const startTs = (cells[1].textContent || '').trim();
            const endTs = (cells[2].textContent || '').trim();
            const status = (cells[3].textContent || '').trim();
            stageState.set(stageName, {
              start_ts: startTs && startTs !== '-' ? startTs : null,
              end_ts: endTs && endTs !== '-' ? endTs : null,
              status: status && status !== '-' ? status : null,
            });
          }
        }
      });
    }

    function parseTs(ts) {
      if (!ts) return null;
      const ms = Date.parse(ts);
      return Number.isFinite(ms) ? ms : null;
    }

    function formatDurationSec(startTs, endTs) {
      const start = parseTs(startTs);
      const end = parseTs(endTs);
      if (start === null || end === null) return '-';
      const sec = (end - start) / 1000.0;
      if (!Number.isFinite(sec) || sec < 0) return '-';
      return sec.toFixed(1);
    }

    function upsertStageRow(stageName) {
      if (!stageBody) return null;
      if (stageRows.has(stageName)) return stageRows.get(stageName);
      const tr = document.createElement('tr');
      tr.dataset.stage = stageName;
      tr.innerHTML = `
        <td>${stageName}</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
      `;
      stageBody.appendChild(tr);
      stageRows.set(stageName, tr);
      return tr;
    }

    function updateStageTimeline(event) {
      const eventType = event.event_type || '';
      if (!eventType.startsWith('stage.')) return;
      const stageName = event.stage;
      if (!stageName) return;
      const current = stageState.get(stageName) || { start_ts: null, end_ts: null, status: null };
      if (eventType === 'stage.start') {
        current.start_ts = event.ts || current.start_ts;
        current.end_ts = null;
        current.status = 'running';
      } else if (eventType === 'stage.end') {
        current.end_ts = event.ts || current.end_ts;
        current.status = event.status || 'ok';
      } else {
        return;
      }
      stageState.set(stageName, current);
      const tr = upsertStageRow(stageName);
      if (!tr) return;
      const cells = tr.querySelectorAll('td');
      if (cells.length < 5) return;
      cells[1].textContent = current.start_ts || '-';
      cells[2].textContent = current.end_ts || '-';
      cells[3].textContent = current.status || '-';
      cells[4].textContent = current.start_ts && current.end_ts
        ? formatDurationSec(current.start_ts, current.end_ts)
        : '-';
    }

    function applyFilter() {
      const showAll = toggle && toggle.checked;
      rows.forEach((row) => {
        const kind = row.dataset.kind;
        row.style.display = showAll || kind === 'stage' ? '' : 'none';
      });
    }

    function setLiveStatus(active, label) {
      if (!liveStatus) return;
      liveStatus.textContent = label;
      liveStatus.classList.remove('status-live', 'status-off');
      liveStatus.classList.add(active ? 'status-live' : 'status-off');
    }

    function isStageEvent(eventType) {
      return eventType.startsWith('stage.') || eventType === 'run.start' || eventType === 'run.end';
    }

    function eventLevel(event) {
      const status = event.status || event.status_code;
      if (event.error) return 'error';
      if (typeof status === 'string' && ['error', 'failed'].includes(status.toLowerCase())) return 'error';
      if (typeof status === 'number' && status >= 400) return 'error';
      return 'info';
    }

    function eventSummary(event) {
      const eventType = event.event_type || '-';
      if (eventType === 'run.start') {
        return `run.start mode=${event.mode || '-'}`;
      }
      if (eventType === 'run.end') {
        return `run.end status=${event.status || '-'}`;
      }
      if (eventType.startsWith('stage.')) {
        const status = event.status ? ` status=${event.status}` : '';
        return `${event.stage || '-'}${status}`;
      }
      if (eventType.startsWith('llm.')) {
        const step = event.llm_step || '-';
        const seed = event.seed_id || '-';
        if (eventType === 'llm.fallback') {
          return `llm.fallback step=${step} seed=${seed} reason=${event.error_type || '-'}`;
        }
        if (eventType === 'llm.parse_error') {
          return `llm.parse_error step=${step} seed=${seed} type=${event.error_type || '-'}`;
        }
        return `${eventType} step=${step} seed=${seed}`;
      }
      if (eventType.startsWith('api.')) {
        return `${event.http_method || '-'} ${event.path || '-'}`;
      }
      if (eventType.startsWith('tool.')) {
        return event.tool || eventType;
      }
      return eventType;
    }

    function buildDetails(event) {
      const drop = new Set(['ts', 'event_type', 'analysis_id', 'run_id', 'stage', 'ref']);
      const extra = {};
      Object.keys(event || {}).forEach((key) => {
        if (!drop.has(key)) {
          extra[key] = event[key];
        }
      });
      const keys = Object.keys(extra);
      if (!keys.length) return null;
      return JSON.stringify(extra, null, 2);
    }

    function addEventRow(event) {
      if (!flowBody) return;
      const eventType = event.event_type || '-';
      const isStage = isStageEvent(eventType);
      const level = eventLevel(event);
      const summary = eventSummary(event);
      const details = buildDetails(event);
      const tr = document.createElement('tr');
      tr.dataset.kind = isStage ? 'stage' : 'event';
      tr.className = `level-${level}`;
      const ref = event.ref ? `<a href="/runs/${analysisId}/artifact/${event.ref}">${event.ref}</a>` : '-';
      const detailCell = details
        ? `<details><summary>Details</summary><pre>${details}</pre></details>`
        : '-';
      tr.innerHTML = `
        <td>${event.ts || '-'}</td>
        <td>${eventType}</td>
        <td>${event.stage || '-'}</td>
        <td>${summary}</td>
        <td>${ref}</td>
        <td>${detailCell}</td>
      `;
      flowBody.appendChild(tr);
      rows.push(tr);
      applyFilter();
    }

    function connectStream() {
      if (!flowBody) return;
      if (eventSource) {
        eventSource.close();
      }
      const params = new URLSearchParams();
      if (runId) {
        params.set('run_id', runId);
      }
      params.set('from_start', 'false');
      eventSource = new EventSource(`/api/runs/stream/${analysisId}?${params.toString()}`);
      setLiveStatus(true, 'Connecting');
      eventSource.onopen = () => {
        setLiveStatus(true, 'Connected');
      };
      eventSource.onmessage = (message) => {
        try {
          const event = JSON.parse(message.data);
          updateStageTimeline(event);
          addEventRow(event);
        } catch (err) {
          console.warn('Failed to parse event', err);
        }
      };
      eventSource.onerror = () => {
        setLiveStatus(false, 'Disconnected');
      };
    }

    if (toggle) {
      toggle.addEventListener('change', applyFilter);
    }
    if (liveToggle) {
      liveToggle.addEventListener('change', () => {
        if (liveToggle.checked) {
          connectStream();
        } else if (eventSource) {
          eventSource.close();
          setLiveStatus(false, 'Paused');
        }
      });
    }
    applyFilter();
    if (liveToggle && liveToggle.checked) {
      connectStream();
    }
  </script>
</body>
</html>
